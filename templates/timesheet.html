{% extends 'base.html' %}

{% block title %}Timesheet - {{ period.name }} - Creative Closets Payroll{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-clock"></i> Timesheet: {{ period.name }}</h4>
                <div>
                    <a href="{{ url_for('export_data', period_id=period.id) }}" class="btn btn-info">
                        <i class="fas fa-file-export"></i> Export to Excel
                    </a>
                    <a href="{{ url_for('pay_periods') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Pay Periods
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Enter hours worked or pay amount directly. If hourly rate is set for an employee, pay will be calculated automatically when hours are entered.
                </div>
                
                <h1 class="text-center mb-4">CREATIVE CLOSETS PAYROLL TIME SHEET</h1>
                
                <!-- INSTALL CREWS -->
                {% for crew_num, crew_employees in install_crews %}
                        <div class="crew-section mb-5" data-crew="{{ crew_num }}">
                            <h3 class="bg-dark text-white p-2">INSTALL CREW # {{ crew_num }}</h3>
                            
                            {% for employee in crew_employees %}
                                <div class="employee-timesheet mb-4" 
                                     data-employee="{{ employee.name }}" 
                                 data-role="{{ employee.position }}" 
                                     data-crew="{{ crew_num }}">
                                    <h4 class="bg-secondary text-white p-2">{{ employee.name }}</h4>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>DAY</th>
                                                    <th>DATE</th>
                                                    <th>PROJECT NAME</th>
                                                    <th>DAYS</th>
                                                {% if employee.position != 'assistant' %}
                                                    <th>INSTALL</th>
                                                    <th>ASST PAY</th>
                                                    {% endif %}
                                                    <th>HOURS</th>
                                                    <th>PAY</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for day in days %}
                                                <tr data-date="{{ day.date }}">
                                                    <td>{{ day.day }}</td>
                                                    <td>{{ day.date }}</td>
                                                    <td>
                                                        <input type="text" 
                                                               class="form-control form-control-sm project-input" 
                                                               data-employee="{{ employee.name }}" 
                                                               data-day="{{ day.date }}" 
                                                               data-field="project_name"
                                                               value="{% if employee.name in timesheet and day.date in timesheet[employee.name] %}{{ timesheet[employee.name][day.date].project_name }}{% endif %}">
                                                    </td>
                                                    <td>
                                                        <input type="text" 
                                                               class="form-control form-control-sm install-days-input" 
                                                               data-employee="{{ employee.name }}" 
                                                               data-day="{{ day.date }}" 
                                                               data-field="install_days"
                                                               value="{% if employee.name in timesheet and day.date in timesheet[employee.name] %}{{ timesheet[employee.name][day.date].install_days }}{% endif %}">
                                                    </td>
                                                {% if employee.position != 'assistant' %}
                                                    <td>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" 
                                                                   class="form-control form-control-sm install-input" 
                                                                   data-employee="{{ employee.name }}" 
                                                                   data-day="{{ day.date }}" 
                                                                   data-field="install"
                                                                   step="0.01" 
                                                                   min="0" 
                                                                   value="{% if employee.name in timesheet and day.date in timesheet[employee.name] and timesheet[employee.name][day.date].install %}{{ timesheet[employee.name][day.date].install }}{% endif %}">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="assistant-pay-display" 
                                                             data-crew="{{ crew_num }}" 
                                                             data-day="{{ day.date }}">
                                                            $0.00
                                                        </div>
                                                    </td>
                                                    {% endif %}
                                                    <td>
                                                        <input type="number" 
                                                               class="form-control form-control-sm hours-input" 
                                                               data-employee="{{ employee.name }}" 
                                                               data-day="{{ day.date }}" 
                                                               data-field="hours"
                                                               step="0.5" 
                                                               min="0" 
                                                               value="{% if employee.name in timesheet and day.date in timesheet[employee.name] %}{{ timesheet[employee.name][day.date].hours }}{% endif %}">
                                                    </td>
                                                    <td>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" 
                                                                   class="form-control form-control-sm pay-input" 
                                                                   data-employee="{{ employee.name }}" 
                                                                   data-day="{{ day.date }}" 
                                                                   data-field="pay"
                                                                   step="0.01" 
                                                                   min="0" 
                                                                   value="{% if employee.name in timesheet and day.date in timesheet[employee.name] %}{{ timesheet[employee.name][day.date].pay }}{% endif %}">
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                <tr>
                                                <td colspan="{% if employee.position != 'assistant' %}6{% else %}4{% endif %}" class="text-end fw-bold">TOTAL</td>
                                                <td class="employee-hours-total"></td>
                                                <td class="employee-pay-total"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
                
                <!-- PROJECT MANAGERS -->
                {% if position_groups.project_managers %}
                    <div class="position-section mb-5">
                        <h3 class="bg-success text-white p-2">PROJECT MANAGERS</h3>
                        
                        {% for employee in position_groups.project_managers %}
                            {% if employee.pay_type == 'salary' %}
                                {% include 'partials/employee_timesheet_salary.html' %}
                            {% else %}
                                {% include 'partials/employee_timesheet_standard.html' %}
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- CEO -->
                {% if position_groups.ceo %}
                    <div class="position-section mb-5">
                        <h3 class="bg-danger text-white p-2">EXECUTIVE</h3>
                        
                        {% for employee in position_groups.ceo %}
                            {% if employee.pay_type == 'salary' %}
                                {% include 'partials/employee_timesheet_salary.html' %}
                            {% else %}
                                {% include 'partials/employee_timesheet_standard.html' %}
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- ENGINEERS -->
                {% if position_groups.engineers %}
                    <div class="position-section mb-5">
                        <h3 class="bg-warning text-dark p-2">ENGINEERS</h3>
                        
                        {% for employee in position_groups.engineers %}
                            {% if employee.pay_type == 'salary' %}
                                {% include 'partials/employee_timesheet_salary.html' %}
                            {% else %}
                                {% include 'partials/employee_timesheet_standard.html' %}
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- SALESMEN -->
                {% if position_groups.salesmen %}
                    <div class="position-section mb-5">
                        <h3 class="bg-dark text-white p-2">SALES</h3>
                        
                        {% for employee in position_groups.salesmen %}
                            {% include 'partials/employee_timesheet_standard.html' %}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- OTHER EMPLOYEES -->
                {% if position_groups.other %}
                    <div class="position-section mb-5">
                        <h3 class="bg-secondary text-white p-2">OTHER EMPLOYEES</h3>
                        
                        {% for employee in position_groups.other %}
                            {% include 'partials/employee_timesheet_standard.html' %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set default values for salaried employees
        document.querySelectorAll('input[placeholder="Salaried"]').forEach(input => {
            if (!input.value) {
                input.value = "40"; // Default to 40 hours for salaried
            }
        });
        
        // For salaried employees with empty pay, set to salary / 52
        document.querySelectorAll('.pay-input').forEach(input => {
            const placeholder = input.getAttribute('placeholder');
            if (placeholder && !input.value && parseFloat(placeholder) > 0) {
                input.value = placeholder; // Use placeholder (salary/52) as value
                
                // Trigger change event to save to server
                const changeEvent = new Event('change');
                input.dispatchEvent(changeEvent);
            }
        });
        
        // Sync project name and days from lead installers to assistant installers
        syncLeadToAssistants();
        
        // Handle input changes
        const inputs = document.querySelectorAll('.hours-input, .pay-input, .project-input, .install-days-input, .install-input');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                const employee = this.dataset.employee;
                const day = this.dataset.day;
                const field = this.dataset.field;
                const value = this.value;
                
                // Send update to server
                fetch('{{ url_for("update_timesheet", period_id=period.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        employee: employee,
                        day: day,
                        field: field,
                        value: value
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If hours were updated and pay was calculated, update the pay field
                        if (field === 'hours') {
                            const payInput = document.querySelector(`.pay-input[data-employee="${employee}"][data-day="${day}"]`);
                            if (payInput && data.pay) {
                                payInput.value = data.pay;
                            }
                            
                            // If the employee is an assistant installer, update the assistant pay display
                            if (isAssistantInstaller(employee)) {
                                updateAssistantPay(day);
                                // Also update lead installer pay since it depends on assistant pay
                                setTimeout(() => {
                                    updateLeadInstallerPay(day);
                                }, 500); // Small delay to ensure assistant pay is calculated first
                            }
                            // If the employee is a lead installer, recalculate pay with the formula
                            else if (isLeadInstaller(employee)) {
                                updateLeadInstallerPay(day);
                            }
                        }
                        
                        // If project name or install days were updated by a lead installer, update assistant installers
                        if ((field === 'project_name' || field === 'install_days') && isLeadInstaller(employee)) {
                            // Get the crew number of this lead installer
                            const leadElm = document.querySelector(`[data-employee="${employee}"]`);
                            if (leadElm) {
                                const crewNum = leadElm.dataset.crew;
                                
                                // Update all assistant installers in the same crew
                                document.querySelectorAll(`[data-role="assistant"][data-crew="${crewNum}"]`).forEach(assistantElm => {
                                    const assistantName = assistantElm.dataset.employee;
                                    
                                    // Update the corresponding field
                                    const assistantInput = document.querySelector(`.${field}-input[data-employee="${assistantName}"][data-day="${day}"]`);
                                    if (assistantInput) {
                                        // Only update if the assistant doesn't have a value or if we're syncing the crew
                                        if (!assistantInput.value || assistantInput.value !== value) {
                                            assistantInput.value = value;
                                            
                                            // Save directly instead of triggering change event to avoid loops
                                            saveTimesheet(assistantName, day, field, value);
                                        }
                                    }
                                });
                            }
                        }
                        
                        // If install amount was updated, calculate and display assistant pay
                        if (field === 'install') {
                            // Only need to update lead pay since assistant pay is now based on hours, not install amount
                            updateLeadInstallerPay(day);
                        }
                        
                        // Update totals
                        calculateTotals();
                    }
                })
                .catch(error => {
                    console.error('Error updating timesheet:', error);
                });
            });
        });
        
        // Calculate initial totals
        calculateTotals();
        
        // Initial update of assistant pay displays
        updateAllAssistantPay();
        
        // Initial update of lead installer pay (after assistant pay is calculated)
        setTimeout(() => {
            updateAllLeadInstallerPay();
        }, 1000); // Give time for assistant pay API calls to complete
    });
    
    // Check if an employee is a lead installer
    function isLeadInstaller(employeeName) {
        const empElement = document.querySelector(`[data-employee="${employeeName}"]`);
        return empElement && empElement.dataset.role === 'lead';
    }
    
    // Check if an employee is an assistant installer
    function isAssistantInstaller(employeeName) {
        const empElement = document.querySelector(`[data-employee="${employeeName}"]`);
        return empElement && empElement.dataset.role === 'assistant';
    }
    
    // Sync project name and days from lead installers to assistant installers
    function syncLeadToAssistants() {
        // Find all crews
        document.querySelectorAll('.crew-section').forEach(crewSection => {
            const crewNum = crewSection.dataset.crew;
            
            // Find lead installer in this crew
            const leadElement = crewSection.querySelector('[data-role="lead"]');
            if (!leadElement) return;
            
            const leadName = leadElement.dataset.employee;
            
            // Find all assistant installers in this crew
            const assistantElements = crewSection.querySelectorAll('[data-role="assistant"]');
            
            // For each day, copy project name and days from lead to assistants
            document.querySelectorAll('[data-date]').forEach(dayRow => {
                const day = dayRow.dataset.date;
                
                // Get project name and days from lead installer
                const projectInput = document.querySelector(`.project-input[data-employee="${leadName}"][data-day="${day}"]`);
                const daysInput = document.querySelector(`.install-days-input[data-employee="${leadName}"][data-day="${day}"]`);
                
                if (projectInput && projectInput.value) {
                    // Copy to all assistants
                    assistantElements.forEach(assistantElem => {
                        const assistantName = assistantElem.dataset.employee;
                        
                        // Copy project name
                        const assistantProjectInput = document.querySelector(`.project-input[data-employee="${assistantName}"][data-day="${day}"]`);
                        if (assistantProjectInput && !assistantProjectInput.value) {
                            assistantProjectInput.value = projectInput.value;
                            
                            // Save the value to the server
                            saveTimesheet(assistantName, day, 'project_name', projectInput.value);
                        }
                    });
                }
                
                if (daysInput && daysInput.value) {
                    // Copy to all assistants
                    assistantElements.forEach(assistantElem => {
                        const assistantName = assistantElem.dataset.employee;
                        
                        // Copy days
                        const assistantDaysInput = document.querySelector(`.install-days-input[data-employee="${assistantName}"][data-day="${day}"]`);
                        if (assistantDaysInput && !assistantDaysInput.value) {
                            assistantDaysInput.value = daysInput.value;
                            
                            // Save the value to the server
                            saveTimesheet(assistantName, day, 'install_days', daysInput.value);
                        }
                    });
                }
            });
        });
    }
    
    // Helper function to save timesheet data to the server
    function saveTimesheet(employee, day, field, value) {
            fetch('{{ url_for("update_timesheet", period_id=period.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                employee: employee,
                    day: day,
                field: field,
                value: value
            }),
        }).catch(error => {
            console.error('Error updating timesheet:', error);
        });
    }
    
    // Update assistant pay for a specific day
    function updateAssistantPay(day) {
        // Process each crew
        document.querySelectorAll('[data-crew]').forEach(crewElm => {
            if (crewElm.classList.contains('crew-section')) {
                const crewNum = crewElm.dataset.crew;
                
                // Find all assistant installers in this crew
                const assistantElements = crewElm.querySelectorAll('[data-role="assistant"]');
                
                assistantElements.forEach(assistantElem => {
                    const assistantName = assistantElem.dataset.employee;
                    const assistantHoursInput = crewElm.querySelector(`[data-role="assistant"][data-employee="${assistantName}"] .hours-input[data-day="${day}"]`);
                    
                    if (assistantHoursInput && assistantHoursInput.value) {
                        const assistantHours = parseFloat(assistantHoursInput.value);
                        
                        // Fetch this assistant's hourly rate
                        fetch(`/get_employee_rate?name=${encodeURIComponent(assistantName)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.rate) {
                                    const assistantRate = parseFloat(data.rate);
                                    const assistantPay = assistantHours * assistantRate;
                                    
                                    // Update assistant pay display
                                    const assistantPayDisplay = crewElm.querySelector(`.assistant-pay-display[data-crew="${crewNum}"][data-day="${day}"]`);
                                    if (assistantPayDisplay) {
                                        assistantPayDisplay.textContent = `$${assistantPay.toFixed(2)}`;
                                    }
                                }
                            })
                            .catch(error => {
                                console.error(`Error getting rate for ${assistantName}:`, error);
                            });
                    } else {
                        // No hours entered, set pay to zero
                        const assistantPayDisplay = crewElm.querySelector(`.assistant-pay-display[data-crew="${crewNum}"][data-day="${day}"]`);
                        if (assistantPayDisplay) {
                            assistantPayDisplay.textContent = '$0.00';
                        }
                    }
                });
            }
        });
    }
    
    // Update all assistant pay displays
    function updateAllAssistantPay() {
        document.querySelectorAll('[data-date]').forEach(dayRow => {
            const day = dayRow.dataset.date;
            updateAssistantPay(day);
        });
    }
    
    // Update lead installer's pay for a specific day
    function updateLeadInstallerPay(day) {
        // Process each crew
        document.querySelectorAll('[data-crew]').forEach(crewElm => {
            if (crewElm.classList.contains('crew-section')) {
                const crewNum = crewElm.dataset.crew;
                
                // Find the lead installer for this crew
                const leadElement = crewElm.querySelector('[data-role="lead"]');
                if (!leadElement) return;
                
                const leadName = leadElement.dataset.employee;
                
                // Find the lead installer's install amount and hours for this day
                let leadInstallAmount = 0;
                let leadHours = 0;
                const leadInstallInput = crewElm.querySelector(`[data-role="lead"] .install-input[data-day="${day}"]`);
                const leadHoursInput = crewElm.querySelector(`[data-role="lead"] .hours-input[data-day="${day}"]`);
                
                if (leadInstallInput && leadInstallInput.value) {
                    leadInstallAmount = parseFloat(leadInstallInput.value);
                } else {
                    // Skip if no install amount
                    return;
                }
                
                if (leadHoursInput && leadHoursInput.value) {
                    leadHours = parseFloat(leadHoursInput.value);
                }
                
                // Get all assistant installers in this crew
                const assistantElements = crewElm.querySelectorAll('[data-role="assistant"]');
                
                // Calculate total assistant pay for this crew and day
                // We need to fetch all assistants' hourly rates and calculate based on their hours
                const assistantPromises = [];
                
                assistantElements.forEach(assistantElem => {
                    const assistantName = assistantElem.dataset.employee;
                    const assistantHoursInput = crewElm.querySelector(`[data-role="assistant"][data-employee="${assistantName}"] .hours-input[data-day="${day}"]`);
                    
                    if (assistantHoursInput && assistantHoursInput.value) {
                        const assistantHours = parseFloat(assistantHoursInput.value);
                        
                        // Fetch this assistant's hourly rate
                        const promise = fetch(`/get_employee_rate?name=${encodeURIComponent(assistantName)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.rate) {
                                    const assistantRate = parseFloat(data.rate);
                                    return assistantHours * assistantRate;
                                }
                                return 0;
                            })
                            .catch(error => {
                                console.error(`Error getting rate for ${assistantName}:`, error);
                                return 0;
                            });
                        
                        assistantPromises.push(promise);
                    }
                });
                
                // When all assistant pay calculations are done
                Promise.all(assistantPromises)
                    .then(assistantPayAmounts => {
                        // Sum up all assistant pay amounts
                        const totalAssistantPay = assistantPayAmounts.reduce((sum, pay) => sum + pay, 0);
                        
                        // Fetch lead installer's hourly rate
                        fetch(`/get_employee_rate?name=${encodeURIComponent(leadName)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.rate) {
                                    const hourlyRate = parseFloat(data.rate);
                                    
                                    // Calculate lead installer pay: (INSTALL value - total of assistant installers pay) + (lead installers hours x hourly rate)
                                    const installPortion = leadInstallAmount - totalAssistantPay;
                                    const hourlyPortion = leadHours * hourlyRate;
                                    const totalPay = installPortion + hourlyPortion;
                                    
                                    // Update the lead installer's pay input
                                    const leadPayInput = crewElm.querySelector(`[data-role="lead"] .pay-input[data-day="${day}"]`);
                                    if (leadPayInput) {
                                        leadPayInput.value = totalPay.toFixed(2);
                                        
                                        // Save to server
                                        saveTimesheet(leadName, day, 'pay', totalPay.toFixed(2));
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error getting employee rate:', error);
                            });
                    });
            }
        });
    }
    
    // Update all lead installer pay
    function updateAllLeadInstallerPay() {
        document.querySelectorAll('[data-date]').forEach(dayRow => {
            const day = dayRow.dataset.date;
            updateLeadInstallerPay(day);
        });
    }
    
    // Calculate totals for each employee
        function calculateTotals() {
        document.querySelectorAll('.employee-timesheet').forEach(employeeSection => {
                let totalHours = 0;
                let totalPay = 0;
                
            // Get all hours inputs for this employee
            employeeSection.querySelectorAll('.hours-input').forEach(hoursInput => {
                if (hoursInput.value) {
                    totalHours += parseFloat(hoursInput.value);
                }
            });
            
            // Get all pay inputs for this employee
            employeeSection.querySelectorAll('.pay-input').forEach(payInput => {
                if (payInput.value) {
                    totalPay += parseFloat(payInput.value);
                }
            });
            
            // Update total displays
            const hoursTotal = employeeSection.querySelector('.employee-hours-total');
            const payTotal = employeeSection.querySelector('.employee-pay-total');
                
                if (hoursTotal) {
                    hoursTotal.textContent = totalHours.toFixed(1);
                }
                
                if (payTotal) {
                payTotal.textContent = `$${totalPay.toFixed(2)}`;
                }
            });
        }
</script>
{% endblock %} 